<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data â€” EstaciÃ³n MeteorolÃ³gica</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="light dark" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="brand" href="index.html">
        <span class="brand-icon" aria-hidden="true">â›…</span>
        <span class="brand-text">MeteoLab</span>
      </a>
      <nav class="top-nav" aria-label="Secciones">
        <a href="index.html" class="nav-link">Inicio</a>
        <a href="datos.html" class="nav-link" aria-current="page">Datos</a>
        <a href="proyectos.html" class="nav-link">Proyectos</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>Datos metereolÃ³gicos</h1>
      <p class="lead">
        Las lecturas se actualizan en tiempo real. Desde este apartado, puedes consultar las condiciones climÃ¡ticas actuales de la ciudad de Arequipa.
      </p>

      <div class="stats">
        <div class="stat">
          <div class="stat-label">Fuente</div>
          <div class="stat-value">ESP32</div>
        </div>
        <div class="stat">
          <div class="stat-label">ID Sitio</div>
          <div class="stat-value">3123892</div>
        </div>
        <div class="stat">
          <div class="stat-label">Ãšltima lectura</div>
          <div class="stat-value" id="last-update">â€”</div>
        </div>
      </div>
    </div>
  </section>

  <main class="container" style="margin-top:14px">
    <!-- Controles -->
    <section class="toolbar" aria-label="Controles de datos">
      <div class="filters">
        <label class="select">
          <span>Muestras</span>
          <select id="results-select" aria-label="Cantidad de muestras">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
        </label>

        <label class="select">
          <span>Zona horaria</span>
          <select id="tz-select" aria-label="Zona horaria">
            <option value="local" selected>Local del navegador</option>
            <option value="UTC">UTC</option>
          </select>
        </label>

        <!-- NUEVO: rango de fechas -->
        <label class="select">
          <span>Desde</span>
          <input type="date" id="start-date">
        </label>

        <label class="select">
          <span>Hasta</span>
          <input type="date" id="end-date">
        </label>
      </div>

      <div class="toolbar-actions">
        <button id="reload-btn" class="btn">Recargar</button>
        <button id="download-btn" class="btn">Descargar CSV</button>
      </div>
    </section>

    <!-- NUEVO: Ãšltima lectura en nÃºmeros -->
    <section class="stats" aria-label="Ãšltima lectura" style="padding-bottom: 14px;">
      <div class="stat">
        <div class="stat-label">Temperatura</div>
        <div class="stat-value" id="last-field-1">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-label">Humedad</div>
        <div class="stat-value" id="last-field-2">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-label">PresiÃ³n</div>
        <div class="stat-value" id="last-field-3">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-label">Velocidad Viento</div>
        <div class="stat-value" id="last-field-4">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-label">DirecciÃ³n Viento</div>
        <div class="stat-value" id="last-field-5">â€”</div>
      </div>
      <div class="stat">
        <div class="stat-label">RadiaciÃ³n</div>
        <div class="stat-value" id="last-field-6">â€”</div>
      </div>
    </section>

    <!-- 6 grÃ¡ficos en grilla (3 por fila desktop, 1 mÃ³vil) -->
    <section class="grid three" aria-label="GrÃ¡ficas">
      <article class="card">
        <header class="card-head"><h3 id="title-1">Field 1</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-1" height="220" aria-label="GrÃ¡fico field 1" role="img"></canvas>
          <p class="chart-note" id="note-1">Ãšltimas muestras de field 1.</p>
          <div class="mini-status" id="status-1" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-2">Field 2</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-2" height="220" aria-label="GrÃ¡fico field 2" role="img"></canvas>
          <p class="chart-note" id="note-2">Ãšltimas muestras de field 2.</p>
          <div class="mini-status" id="status-2" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-3">Field 3</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-3" height="220" aria-label="GrÃ¡fico field 3" role="img"></canvas>
          <p class="chart-note" id="note-3">Ãšltimas muestras de field 3.</p>
          <div class="mini-status" id="status-3" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-4">Field 4</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-4" height="220" aria-label="GrÃ¡fico field 4" role="img"></canvas>
          <p class="chart-note" id="note-4">Ãšltimas muestras de field 4.</p>
          <div class="mini-status" id="status-4" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-5">DirecciÃ³n del Viento</h3></header>
        <div class="chart-wrap" id="compass-wrap-5">
          <canvas id="chart-5" height="220" aria-label="GrÃ¡fico field 5" role="img"></canvas>
          <p class="chart-note" id="note-5">Ãšltimas muestras de direcciÃ³n del viento.</p>
          <div class="mini-status" id="status-5" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-6">Field 6</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-6" height="220" aria-label="GrÃ¡fico field 6" role="img"></canvas>
          <p class="chart-note" id="note-6">Ãšltimas muestras de field 6.</p>
          <div class="mini-status" id="status-6" hidden></div>
        </div>
      </article>
    </section>

    <!-- Estado general -->
    <section class="about" id="status-box" aria-live="polite" style="display:none;"></section>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <p>Â© <span id="year">2025</span> MeteoLab</p>
      <nav class="footer-links" aria-label="Enlaces de pie de pÃ¡gina">
        <a href="#">Contacto</a>
        <a href="#">PolÃ­tica de datos</a>
        <a href="#">Licencia</a>
      </nav>
    </div>
  </footer>

  <script>
    // ====== Config ======
    const CHANNEL_ID = 3123892;
    const READ_API_KEY = 'N6NW577NEBRAZ9A6';
    const FIELDS = [1,2,3,4,5,6];

    // ðŸ‘‰ IMPORTANTE: FIELD_META definido AQUÃ, a nivel global, fuera de cualquier funciÃ³n
    const FIELD_META = {
      1: { label: 'Temperatura',      unit: 'Â°C',   yTitle: 'Temperatura (Â°C)' },
      2: { label: 'Humedad',          unit: '%',    yTitle: 'Humedad relativa (%)' },
      3: { label: 'PresiÃ³n',          unit: 'hPa',  yTitle: 'PresiÃ³n (hPa)' },
      4: { label: 'Velocidad Viento', unit: 'm/s',  yTitle: 'Velocidad del viento (m/s)' },
      5: { label: 'DirecciÃ³n Viento', unit: 'Â°',    yTitle: 'DirecciÃ³n del viento (Â°)' },
      6: { label: 'RadiaciÃ³n',        unit: '', yTitle: 'Ãndice de radiaciÃ³n' }
    };

    // ====== Estilos desde variables CSS ======
    function cssVar(name, fallback) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fallback;
    }
    const cBrand  = cssVar('--brand', '#0b74ff');
    const cBrand2 = cssVar('--brand-2', '#2bb8ff');
    const cText   = cssVar('--text', '#182238');
    const cGrid   = 'rgba(128, 128, 128, .2)';

    // ====== Estado general UI ======
    const statusBox = document.getElementById('status-box');
    function setStatus(html) { statusBox.style.display = 'block'; statusBox.innerHTML = html; }
    function clearStatus(){ statusBox.style.display = 'none'; statusBox.innerHTML = ''; }

    // ====== Helpers fecha/labels ======
    function formatLabel(tsISO, mode = 'local') {
      const d = new Date(tsISO);
      if (mode === 'UTC') {
        const mm = String(d.getUTCMonth()+1).padStart(2,'0');
        const dd = String(d.getUTCDate()).padStart(2,'0');
        const hh = String(d.getUTCHours()).padStart(2,'0');
        return `${mm}-${dd} ${hh}:00Z`;
      } else {
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        return `${mm}-${dd} ${hh}:00`;
      }
    }

    // ====== Helper direcciÃ³n cardinal ======
    function degreesToCardinal(deg) {
      const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
      const index = Math.round(deg / 22.5) % 16;
      return dirs[index];
    }

    // ====== Chart factory ======
    function mkLineChart(ctx, labels, data, label, yTitle) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data,
            borderColor: cBrand,
            backgroundColor: cBrand2,
            tension: 0.25,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              grid: { color: cGrid },
              ticks: {
                autoSkip: true,
                maxRotation: 0,
                callback: (v, i) => (i % 6 === 0 ? labels[v] : '')
              }
            },
            y: {
              grid: { color: cGrid },
              title: { display: true, text: yTitle, color: cText }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => items?.[0]?.label ?? '',
                label: (item) => `${item.dataset.label}: ${item.formattedValue}`
              }
            }
          }
        }
      });
    }

    // ====== BrÃºjula para direcciÃ³n del viento ======
    function drawCompass(ctx, direction) {
      const canvas = ctx.canvas;
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) * 0.35;

      // Limpiar canvas
      ctx.clearRect(0, 0, width, height);

      // Fondo del cÃ­rculo
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.fillStyle = cssVar('--panel', '#111a2b');
      ctx.fill();
      ctx.strokeStyle = cssVar('--brand', '#4db6ff');
      ctx.lineWidth = 3;
      ctx.stroke();

      // Puntos cardinales
      ctx.font = 'bold 18px sans-serif';
      ctx.fillStyle = cssVar('--text', '#eaf1ff');
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      const cardinals = [
        { label: 'N', angle: 0 },
        { label: 'E', angle: 90 },
        { label: 'S', angle: 180 },
        { label: 'O', angle: 270 }
      ];

      cardinals.forEach(({ label, angle }) => {
        const rad = (angle - 90) * Math.PI / 180;
        const x = centerX + Math.cos(rad) * (radius * 0.75);
        const y = centerY + Math.sin(rad) * (radius * 0.75);
        ctx.fillText(label, x, y);
      });

      // Marcas de grados (cada 45Â°)
      ctx.strokeStyle = cssVar('--muted', '#9db0d1');
      ctx.lineWidth = 1;
      for (let i = 0; i < 8; i++) {
        const angle = i * 45;
        const rad = (angle - 90) * Math.PI / 180;
        const x1 = centerX + Math.cos(rad) * (radius * 0.9);
        const y1 = centerY + Math.sin(rad) * (radius * 0.9);
        const x2 = centerX + Math.cos(rad) * (radius * 0.95);
        const y2 = centerY + Math.sin(rad) * (radius * 0.95);
        
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }

      // Aguja del viento
      const windRad = (direction - 90) * Math.PI / 180;
      const needleLength = radius * 0.65;
      const needleWidth = 8;

      // Punta de la aguja (direcciÃ³n del viento)
      const tipX = centerX + Math.cos(windRad) * needleLength;
      const tipY = centerY + Math.sin(windRad) * needleLength;

      // Base de la aguja
      const baseX = centerX - Math.cos(windRad) * (needleLength * 0.2);
      const baseY = centerY - Math.sin(windRad) * (needleLength * 0.2);

      // Perpendiculares para el ancho
      const perpRad = windRad + Math.PI / 2;
      const side1X = centerX + Math.cos(perpRad) * needleWidth;
      const side1Y = centerY + Math.sin(perpRad) * needleWidth;
      const side2X = centerX - Math.cos(perpRad) * needleWidth;
      const side2Y = centerY - Math.sin(perpRad) * needleWidth;

      // Dibujar aguja
      ctx.beginPath();
      ctx.moveTo(tipX, tipY);
      ctx.lineTo(side1X, side1Y);
      ctx.lineTo(baseX, baseY);
      ctx.lineTo(side2X, side2Y);
      ctx.closePath();

      const gradient = ctx.createLinearGradient(baseX, baseY, tipX, tipY);
      gradient.addColorStop(0, cssVar('--brand-2', '#7ce3ff'));
      gradient.addColorStop(1, cssVar('--brand', '#4db6ff'));
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = cssVar('--text', '#eaf1ff');
      ctx.lineWidth = 2;
      ctx.stroke();

      // CÃ­rculo central
      ctx.beginPath();
      ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
      ctx.fillStyle = cssVar('--panel-2', '#0e1626');
      ctx.fill();
      ctx.strokeStyle = cssVar('--brand', '#4db6ff');
      ctx.lineWidth = 2;
      ctx.stroke();

      // Valor en grados y direcciÃ³n cardinal
      ctx.font = 'bold 24px sans-serif';
      ctx.fillStyle = cssVar('--text', '#eaf1ff');
      ctx.textAlign = 'center';
      ctx.fillText(`${Math.round(direction)}Â°`, centerX, centerY + radius + 30);
      
      ctx.font = 'bold 18px sans-serif';
      ctx.fillStyle = cssVar('--brand', '#4db6ff');
      ctx.fillText(degreesToCardinal(direction), centerX, centerY + radius + 55);
    }

    // ====== ThingSpeak requests ======
    async function fetchField(fieldNo, results) {
      const url = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/${fieldNo}.json`);
      url.searchParams.set('api_key', READ_API_KEY);
      url.searchParams.set('results', String(results));
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error(`Field ${fieldNo} HTTP ${res.status}`);
      return res.json();
    }

    async function updateLastUpdate() {
      const el = document.getElementById('last-update');

      // elementos de los stats numÃ©ricos
      const lastFieldEls = {};
      FIELDS.forEach(n => {
        lastFieldEls[n] = document.getElementById(`last-field-${n}`);
      });

      function clearLastFields() {
        FIELDS.forEach(n => {
          if (lastFieldEls[n]) lastFieldEls[n].textContent = 'â€”';
        });
      }

      try {
        const urlLast = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json`);
        urlLast.searchParams.set('api_key', READ_API_KEY);
        const res = await fetch(urlLast.toString());
        if (!res.ok) throw new Error(`last.json HTTP ${res.status}`);
        const json = await res.json();

        // Fecha/hora de la Ãºltima lectura
        if (json && json.created_at) {
          el.textContent = new Date(json.created_at).toLocaleString();
        } else {
          el.textContent = 'â€”';
        }

        // Valores de los 6 fields
        FIELDS.forEach(n => {
          const target = lastFieldEls[n];
          if (!target) return;

          const key = `field${n}`;
          const raw = json[key];

          if (raw === null || raw === undefined) {
            target.textContent = 'â€”';
            return;
          }

          const meta = FIELD_META[n] || {};
          const unit = meta.unit || '';
          let valNum = Number(raw);
          let text = '';

          if (!Number.isFinite(valNum)) {
            // por si llega algo no numÃ©rico
            text = String(raw);
          } else {
            // Formateo sencillo por tipo de campo
            if (n === 2 || n === 3) {
              // Humedad y presiÃ³n, sin decimales
              text = valNum.toFixed(0);
            } else if (n === 5) {
              // DirecciÃ³n del viento: grados + cardinal
              const deg = valNum;
              const cardinal = degreesToCardinal(deg);
              text = `${deg.toFixed(0)}Â° ${cardinal}`;
            } else {
              // El resto con 1 decimal
              text = valNum.toFixed(1);
            }

            if (unit && n !== 5) {
              text = `${text} ${unit}`;
            }
          }

          target.textContent = text;
        });

        return;
      } catch (e) {
        // si falla last.json, intentamos solo la "edad" del dato
        try {
          const urlAge = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last_data_age.json`);
          urlAge.searchParams.set('api_key', READ_API_KEY);
          const res = await fetch(urlAge.toString());
          if (!res.ok) throw new Error(`last_data_age.json HTTP ${res.status}`);
          const age = await res.json();
          const s = Number(age?.last_data_age || 0);
          el.textContent = s ? `hace ${s} s` : 'â€”';
        } catch (e2) {
          el.textContent = 'â€”';
          console.error('Error obteniendo Ãºltima actualizaciÃ³n:', e, e2);
        }

        // si llegamos aquÃ­, no tenemos valores confiables de last.json
        clearLastFields();
      }
    }


    // ====== Render por campo ======
    let charts = {};
    async function renderField(fieldNo, results, tzMode) {
      const titleEl = document.getElementById(`title-${fieldNo}`);
      const noteEl  = document.getElementById(`note-${fieldNo}`);
      const statusEl= document.getElementById(`status-${fieldNo}`);
      const ctx     = document.getElementById(`chart-${fieldNo}`).getContext('2d');

      if (charts[fieldNo]) { charts[fieldNo].destroy(); charts[fieldNo] = null; }

      statusEl.hidden = false;
      statusEl.textContent = 'Cargandoâ€¦';

      try {
        const json = await fetchField(fieldNo, results);

        const ch = json?.channel || {};
        const fieldName = ch[`field${fieldNo}`] || `Field ${fieldNo}`;
        titleEl.textContent = fieldName;

        const feeds = json?.feeds || [];
        const points = feeds
          .map(f => {
            const val = parseFloat(f[`field${fieldNo}`]);
            const t   = f.created_at;
            return (isFinite(val) && t) ? { t, v: val } : null;
          })
          .filter(Boolean);

        if (points.length === 0) {
          statusEl.hidden = false;
          statusEl.textContent = 'Sin datos para este campo.';
          return;
        }

        // Campo 5: DirecciÃ³n del viento (brÃºjula)
        if (fieldNo === 5) {
          noteEl.textContent = `DirecciÃ³n actual del viento: ${fieldName}`;
          
          // Obtener Ãºltima direcciÃ³n
          const lastDirection = points[points.length - 1].v;
          
          // Dibujar brÃºjula
          drawCompass(ctx, lastDirection);
          
          statusEl.hidden = true;
          
          // Almacenar referencia para animaciÃ³n (opcional)
          charts[fieldNo] = { type: 'compass', direction: lastDirection };
        } else {
          // Otros campos: grÃ¡fico de lÃ­neas normal
          noteEl.textContent = `Ãšltimas ${results} muestras de ${fieldName}.`;
          
          const labels = points.map(p => formatLabel(p.t, tzMode));
          const data   = points.map(p => p.v);

          charts[fieldNo] = mkLineChart(ctx, labels, data, fieldName, fieldName);
          statusEl.hidden = true;
        }
      } catch (err) {
        statusEl.hidden = false;
        statusEl.innerHTML = `Error al cargar: <code>${(err && err.message) || err}</code>`;
      }
    }

    // ====== Descargar CSV de todos los fields en un rango de fechas ======
    async function downloadCsvForRange() {
      const startInput = document.getElementById('start-date').value;
      const endInput   = document.getElementById('end-date').value;

      if (!startInput || !endInput) {
        alert('Selecciona fecha de inicio y fecha de fin para descargar el CSV.');
        return;
      }

      // Construimos start/end con hora (ThingSpeak espera fecha+hora)
      const startISO = `${startInput} 00:00:00`;
      const endISO   = `${endInput} 23:59:59`;

      setStatus(`<strong>Generando CSVâ€¦</strong> Rango: ${startInput} a ${endInput}.`);

      try {
        // Usamos /feeds.json para traer todos los fields juntos
        const url = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json`);
        url.searchParams.set('api_key', READ_API_KEY);
        url.searchParams.set('start', startISO);
        url.searchParams.set('end', endISO);
        // Si quieres que ThingSpeak convierta las fechas a tu zona: url.searchParams.set('timezone', 'America/Lima');

        const res = await fetch(url.toString());
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const json  = await res.json();
        const feeds = json?.feeds || [];

        if (!feeds.length) {
          clearStatus();
          alert('No hay datos en ese rango de fechas.');
          return;
        }

        // Cabecera del CSV
        const header = ['timestamp'];
        const fieldKeys = FIELDS.map(n => `field${n}`);
        const fieldLabels = FIELDS.map(n => {
          const meta = FIELD_META[n] || {};
          if (meta.label && meta.unit) return `${meta.label} (${meta.unit})`;
          if (meta.label) return meta.label;
          return `Field ${n}`;
        });

        header.push(...fieldLabels);

        const rows = [];
        rows.push(header.join(','));

        // Filas de datos
        for (const f of feeds) {
          const row = [];

          // created_at tal cual (formato ISO de ThingSpeak)
          row.push(`"${f.created_at}"`);

          for (const key of fieldKeys) {
            const v = f[key];
            if (v === null || v === undefined) {
              row.push('');
            } else {
              // Sin comillas para valores numÃ©ricos simples
              row.push(String(v));
            }
          }

          rows.push(row.join(','));
        }

        const csvContent = rows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const blobUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = `meteo_${startInput}_a_${endInput}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);

        clearStatus();
      } catch (err) {
        console.error(err);
        setStatus(`Error al generar CSV: <code>${(err && err.message) || err}</code>`);
      }
    }


    async function renderAll() {
      const results = Number(document.getElementById('results-select').value);
      const tzMode  = document.getElementById('tz-select').value;

      setStatus(`<strong>Cargandoâ€¦</strong> Leyendo fields 1â€“6 de ThingSpeak (results=${results}).`);

      await updateLastUpdate();

      await Promise.all(FIELDS.map(n => renderField(n, results, tzMode)));

      clearStatus();
    }

    // ====== Eventos ======
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('reload-btn').addEventListener('click', renderAll);
      document.getElementById('results-select').addEventListener('change', renderAll);
      document.getElementById('tz-select').addEventListener('change', renderAll);

      // ðŸ‘‰ NUEVO: botÃ³n de descarga CSV
      document.getElementById('download-btn').addEventListener('click', downloadCsvForRange);
      renderAll();
    });
  </script>

  <style>
    .chart-wrap { position: relative; height: 260px; padding: 8px 12px 26px; }
    .mini-status { position: absolute; left: 12px; bottom: 6px; font-size: .85rem; color: var(--muted); }
    
    /* Estilos especÃ­ficos para la brÃºjula */
    #compass-wrap-5 {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    #chart-5 {
      max-width: 100%;
      height: auto !important;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .toolbar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

  </style>
</body>

</html>
