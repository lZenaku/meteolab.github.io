<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data — Estación Meteorológica</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="color-scheme" content="light dark" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <a class="brand" href="index.html">
        <span class="brand-icon" aria-hidden="true">⛅</span>
        <span class="brand-text">MeteoLab</span>
      </a>
      <nav class="top-nav" aria-label="Secciones">
        <a href="index.html" class="nav-link">Inicio</a>
        <a href="datos.html" class="nav-link" aria-current="page">Datos</a>
        <a href="proyectos.html" class="nav-link">Proyectos</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h1>Datos metereológicos</h1>
      <p class="lead">
        Las lecturas se actualizan en tiempo real. Desde este apartado, puedes consultar las condiciones climáticas actuales de la ciudad de Arequipa.
      </p>

      <div class="stats">
        <div class="stat">
          <div class="stat-label">Fuente</div>
          <div class="stat-value">ESP32</div>
        </div>
        <div class="stat">
          <div class="stat-label">ID Sitio</div>
          <div class="stat-value">3123892</div>
        </div>
        <div class="stat">
          <div class="stat-label">Última lectura</div>
          <div class="stat-value" id="last-update">—</div>
        </div>
      </div>
    </div>
  </section>

  <main class="container" style="margin-top:14px">
    <!-- Controles -->
    <section class="toolbar" aria-label="Controles de datos">
      <div class="filters">
        <label class="select">
          <span>Muestras</span>
          <select id="results-select" aria-label="Cantidad de muestras">
            <option value="50">50</option>
            <option value="100" selected>100</option>
            <option value="200">200</option>
            <option value="500">500</option>
          </select>
        </label>

        <label class="select">
          <span>Zona horaria</span>
          <select id="tz-select" aria-label="Zona horaria">
            <option value="local" selected>Local del navegador</option>
            <option value="UTC">UTC</option>
          </select>
        </label>
      </div>
      <button id="reload-btn" class="btn">Recargar</button>
    </section>

    <!-- 6 gráficos en grilla (3 por fila desktop, 1 móvil) -->
    <section class="grid three" aria-label="Gráficas">
      <article class="card">
        <header class="card-head"><h3 id="title-1">Field 1</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-1" height="220" aria-label="Gráfico field 1" role="img"></canvas>
          <p class="chart-note" id="note-1">Últimas muestras de field 1.</p>
          <div class="mini-status" id="status-1" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-2">Field 2</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-2" height="220" aria-label="Gráfico field 2" role="img"></canvas>
          <p class="chart-note" id="note-2">Últimas muestras de field 2.</p>
          <div class="mini-status" id="status-2" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-3">Field 3</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-3" height="220" aria-label="Gráfico field 3" role="img"></canvas>
          <p class="chart-note" id="note-3">Últimas muestras de field 3.</p>
          <div class="mini-status" id="status-3" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-4">Field 4</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-4" height="220" aria-label="Gráfico field 4" role="img"></canvas>
          <p class="chart-note" id="note-4">Últimas muestras de field 4.</p>
          <div class="mini-status" id="status-4" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-5">Dirección del Viento</h3></header>
        <div class="chart-wrap" id="compass-wrap-5">
          <canvas id="chart-5" height="220" aria-label="Gráfico field 5" role="img"></canvas>
          <p class="chart-note" id="note-5">Últimas muestras de dirección del viento.</p>
          <div class="mini-status" id="status-5" hidden></div>
        </div>
      </article>

      <article class="card">
        <header class="card-head"><h3 id="title-6">Field 6</h3></header>
        <div class="chart-wrap">
          <canvas id="chart-6" height="220" aria-label="Gráfico field 6" role="img"></canvas>
          <p class="chart-note" id="note-6">Últimas muestras de field 6.</p>
          <div class="mini-status" id="status-6" hidden></div>
        </div>
      </article>
    </section>

    <!-- Estado general -->
    <section class="about" id="status-box" aria-live="polite" style="display:none;"></section>
  </main>

  <footer class="site-footer">
    <div class="container footer-grid">
      <p>© <span id="year">2025</span> MeteoLab</p>
      <nav class="footer-links" aria-label="Enlaces de pie de página">
        <a href="#">Contacto</a>
        <a href="#">Política de datos</a>
        <a href="#">Licencia</a>
      </nav>
    </div>
  </footer>

  <script>
    // ====== Config ======
    const CHANNEL_ID = 3123892;
    const READ_API_KEY = 'N6NW577NEBRAZ9A6';
    const FIELDS = [1,2,3,4,5,6];

    // ====== Estilos desde variables CSS ======
    function cssVar(name, fallback) {
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || fallback;
    }
    const cBrand  = cssVar('--brand', '#0b74ff');
    const cBrand2 = cssVar('--brand-2', '#2bb8ff');
    const cText   = cssVar('--text', '#182238');
    const cGrid   = 'rgba(128, 128, 128, .2)';

    // ====== Estado general UI ======
    const statusBox = document.getElementById('status-box');
    function setStatus(html) { statusBox.style.display = 'block'; statusBox.innerHTML = html; }
    function clearStatus(){ statusBox.style.display = 'none'; statusBox.innerHTML = ''; }

    // ====== Helpers fecha/labels ======
    function formatLabel(tsISO, mode = 'local') {
      const d = new Date(tsISO);
      if (mode === 'UTC') {
        const mm = String(d.getUTCMonth()+1).padStart(2,'0');
        const dd = String(d.getUTCDate()).padStart(2,'0');
        const hh = String(d.getUTCHours()).padStart(2,'0');
        return `${mm}-${dd} ${hh}:00Z`;
      } else {
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const hh = String(d.getHours()).padStart(2,'0');
        return `${mm}-${dd} ${hh}:00`;
      }
    }

    // ====== Helper dirección cardinal ======
    function degreesToCardinal(deg) {
      const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
      const index = Math.round(deg / 22.5) % 16;
      return dirs[index];
    }

    // ====== Chart factory ======
    function mkLineChart(ctx, labels, data, label, yTitle) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label,
            data,
            borderColor: cBrand,
            backgroundColor: cBrand2,
            tension: 0.25,
            pointRadius: 0,
            fill: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: {
              grid: { color: cGrid },
              ticks: {
                autoSkip: true,
                maxRotation: 0,
                callback: (v, i) => (i % 6 === 0 ? labels[v] : '')
              }
            },
            y: {
              grid: { color: cGrid },
              title: { display: true, text: yTitle, color: cText }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (items) => items?.[0]?.label ?? '',
                label: (item) => `${item.dataset.label}: ${item.formattedValue}`
              }
            }
          }
        }
      });
    }

    // ====== Brújula para dirección del viento ======
    function drawCompass(ctx, direction) {
      const canvas = ctx.canvas;
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const centerY = height / 2;
      const radius = Math.min(width, height) * 0.35;

      // Limpiar canvas
      ctx.clearRect(0, 0, width, height);

      // Fondo del círculo
      ctx.beginPath();
      ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
      ctx.fillStyle = cssVar('--panel', '#111a2b');
      ctx.fill();
      ctx.strokeStyle = cssVar('--brand', '#4db6ff');
      ctx.lineWidth = 3;
      ctx.stroke();

      // Puntos cardinales
      ctx.font = 'bold 18px sans-serif';
      ctx.fillStyle = cssVar('--text', '#eaf1ff');
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';

      const cardinals = [
        { label: 'N', angle: 0 },
        { label: 'E', angle: 90 },
        { label: 'S', angle: 180 },
        { label: 'O', angle: 270 }
      ];

      cardinals.forEach(({ label, angle }) => {
        const rad = (angle - 90) * Math.PI / 180;
        const x = centerX + Math.cos(rad) * (radius * 0.75);
        const y = centerY + Math.sin(rad) * (radius * 0.75);
        ctx.fillText(label, x, y);
      });

      // Marcas de grados (cada 45°)
      ctx.strokeStyle = cssVar('--muted', '#9db0d1');
      ctx.lineWidth = 1;
      for (let i = 0; i < 8; i++) {
        const angle = i * 45;
        const rad = (angle - 90) * Math.PI / 180;
        const x1 = centerX + Math.cos(rad) * (radius * 0.9);
        const y1 = centerY + Math.sin(rad) * (radius * 0.9);
        const x2 = centerX + Math.cos(rad) * (radius * 0.95);
        const y2 = centerY + Math.sin(rad) * (radius * 0.95);
        
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x2, y2);
        ctx.stroke();
      }

      // Aguja del viento
      const windRad = (direction - 90) * Math.PI / 180;
      const needleLength = radius * 0.65;
      const needleWidth = 8;

      // Punta de la aguja (dirección del viento)
      const tipX = centerX + Math.cos(windRad) * needleLength;
      const tipY = centerY + Math.sin(windRad) * needleLength;

      // Base de la aguja
      const baseX = centerX - Math.cos(windRad) * (needleLength * 0.2);
      const baseY = centerY - Math.sin(windRad) * (needleLength * 0.2);

      // Perpendiculares para el ancho
      const perpRad = windRad + Math.PI / 2;
      const side1X = centerX + Math.cos(perpRad) * needleWidth;
      const side1Y = centerY + Math.sin(perpRad) * needleWidth;
      const side2X = centerX - Math.cos(perpRad) * needleWidth;
      const side2Y = centerY - Math.sin(perpRad) * needleWidth;

      // Dibujar aguja
      ctx.beginPath();
      ctx.moveTo(tipX, tipY);
      ctx.lineTo(side1X, side1Y);
      ctx.lineTo(baseX, baseY);
      ctx.lineTo(side2X, side2Y);
      ctx.closePath();

      const gradient = ctx.createLinearGradient(baseX, baseY, tipX, tipY);
      gradient.addColorStop(0, cssVar('--brand-2', '#7ce3ff'));
      gradient.addColorStop(1, cssVar('--brand', '#4db6ff'));
      ctx.fillStyle = gradient;
      ctx.fill();
      ctx.strokeStyle = cssVar('--text', '#eaf1ff');
      ctx.lineWidth = 2;
      ctx.stroke();

      // Círculo central
      ctx.beginPath();
      ctx.arc(centerX, centerY, 10, 0, 2 * Math.PI);
      ctx.fillStyle = cssVar('--panel-2', '#0e1626');
      ctx.fill();
      ctx.strokeStyle = cssVar('--brand', '#4db6ff');
      ctx.lineWidth = 2;
      ctx.stroke();

      // Valor en grados y dirección cardinal
      ctx.font = 'bold 24px sans-serif';
      ctx.fillStyle = cssVar('--text', '#eaf1ff');
      ctx.textAlign = 'center';
      ctx.fillText(`${Math.round(direction)}°`, centerX, centerY + radius + 30);
      
      ctx.font = 'bold 18px sans-serif';
      ctx.fillStyle = cssVar('--brand', '#4db6ff');
      ctx.fillText(degreesToCardinal(direction), centerX, centerY + radius + 55);
    }

    // ====== ThingSpeak requests ======
    async function fetchField(fieldNo, results) {
      const url = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/${fieldNo}.json`);
      url.searchParams.set('api_key', READ_API_KEY);
      url.searchParams.set('results', String(results));
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error(`Field ${fieldNo} HTTP ${res.status}`);
      return res.json();
    }

    async function updateLastUpdate() {
      const el = document.getElementById('last-update');

      try {
        const urlLast = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last.json`);
        urlLast.searchParams.set('api_key', READ_API_KEY);
        const res = await fetch(urlLast.toString());
        if (!res.ok) throw new Error(`last.json HTTP ${res.status}`);
        const json = await res.json();
        if (json && json.created_at) {
          el.textContent = new Date(json.created_at).toLocaleString();
          return;
        }
        throw new Error('last.json sin created_at');
      } catch (e) {
        try {
          const urlAge = new URL(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds/last_data_age.json`);
          urlAge.searchParams.set('api_key', READ_API_KEY);
          const res = await fetch(urlAge.toString());
          if (!res.ok) throw new Error(`last_data_age.json HTTP ${res.status}`);
          const age = await res.json();
          const s = Number(age?.last_data_age || 0);
          el.textContent = s ? `hace ${s} s` : '—';
        } catch (e2) {
          el.textContent = '—';
          console.error('Error obteniendo última actualización:', e, e2);
        }
      }
    }

    // ====== Render por campo ======
    let charts = {};
    async function renderField(fieldNo, results, tzMode) {
      const titleEl = document.getElementById(`title-${fieldNo}`);
      const noteEl  = document.getElementById(`note-${fieldNo}`);
      const statusEl= document.getElementById(`status-${fieldNo}`);
      const ctx     = document.getElementById(`chart-${fieldNo}`).getContext('2d');

      if (charts[fieldNo]) { charts[fieldNo].destroy(); charts[fieldNo] = null; }

      statusEl.hidden = false;
      statusEl.textContent = 'Cargando…';

      try {
        const json = await fetchField(fieldNo, results);

        const ch = json?.channel || {};
        const fieldName = ch[`field${fieldNo}`] || `Field ${fieldNo}`;
        titleEl.textContent = fieldName;

        const feeds = json?.feeds || [];
        const points = feeds
          .map(f => {
            const val = parseFloat(f[`field${fieldNo}`]);
            const t   = f.created_at;
            return (isFinite(val) && t) ? { t, v: val } : null;
          })
          .filter(Boolean);

        if (points.length === 0) {
          statusEl.hidden = false;
          statusEl.textContent = 'Sin datos para este campo.';
          return;
        }

        // Campo 5: Dirección del viento (brújula)
        if (fieldNo === 5) {
          noteEl.textContent = `Dirección actual del viento: ${fieldName}`;
          
          // Obtener última dirección
          const lastDirection = points[points.length - 1].v;
          
          // Dibujar brújula
          drawCompass(ctx, lastDirection);
          
          statusEl.hidden = true;
          
          // Almacenar referencia para animación (opcional)
          charts[fieldNo] = { type: 'compass', direction: lastDirection };
        } else {
          // Otros campos: gráfico de líneas normal
          noteEl.textContent = `Últimas ${results} muestras de ${fieldName}.`;
          
          const labels = points.map(p => formatLabel(p.t, tzMode));
          const data   = points.map(p => p.v);

          charts[fieldNo] = mkLineChart(ctx, labels, data, fieldName, fieldName);
          statusEl.hidden = true;
        }
      } catch (err) {
        statusEl.hidden = false;
        statusEl.innerHTML = `Error al cargar: <code>${(err && err.message) || err}</code>`;
      }
    }

    async function renderAll() {
      const results = Number(document.getElementById('results-select').value);
      const tzMode  = document.getElementById('tz-select').value;

      setStatus(`<strong>Cargando…</strong> Leyendo fields 1–6 de ThingSpeak (results=${results}).`);

      await updateLastUpdate();

      await Promise.all(FIELDS.map(n => renderField(n, results, tzMode)));

      clearStatus();
    }

    // ====== Eventos ======
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('reload-btn').addEventListener('click', renderAll);
      document.getElementById('results-select').addEventListener('change', renderAll);
      document.getElementById('tz-select').addEventListener('change', renderAll);
      renderAll();
    });
  </script>

  <style>
    .chart-wrap { position: relative; height: 260px; padding: 8px 12px 26px; }
    .mini-status { position: absolute; left: 12px; bottom: 6px; font-size: .85rem; color: var(--muted); }
    
    /* Estilos específicos para la brújula */
    #compass-wrap-5 {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    #chart-5 {
      max-width: 100%;
      height: auto !important;
    }
  </style>
</body>
</html>